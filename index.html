<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesquisa de Reclamações</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    select, #chartContainer {
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      max-width: 400px;
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>

  <h1>Pesquisa de Reclamações por Cliente</h1>

  <label for="cliente">Selecione o Cliente:</label>
  <select id="cliente" onchange="mostrarReclamacoes()">
    <option value="">Escolha um cliente</option>
  </select>

  <h2>Reclamações:</h2>
  <div id="chartContainer">
    <canvas id="reclamacoesChart"></canvas>
  </div>

  <input type="file" id="upload" accept=".xlsx" />
  
  <script>
    let clientesData = [];
    let chart = null;

    document.getElementById('upload').addEventListener('change', function(event) {
      let file = event.target.files[0];
      let reader = new FileReader();

      reader.onload = function(e) {
        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, { type: 'array' });

        // Supondo que os dados estejam na primeira planilha
        let firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        let jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

        // Definir os índices das colunas
        // RAZAO_SOCIAL (Cliente): Coluna 3 (índice 2)
        // PROBLEMA (Descrição): Coluna 7 (índice 6)
        // QUANT_PROBLEMA (Quantidade): Coluna 9 (índice 8)
        
        clientesData = jsonData.slice(1).map(row => ({
          cliente: row[2],      // Coluna RAZAO_SOCIAL
          problema: row[6],     // Coluna PROBLEMA
          quantidade: row[8]    // Coluna QUANT_PROBLEMA
        }));

        // Popular a lista suspensa com os clientes
        let clientesSelect = document.getElementById('cliente');
        let clientesUnicos = [...new Set(clientesData.map(d => d.cliente))];
        clientesUnicos.forEach(cliente => {
          let option = document.createElement('option');
          option.value = cliente;
          option.textContent = cliente;
          clientesSelect.appendChild(option);
        });
      };

      reader.readAsArrayBuffer(file);
    });

    function mostrarReclamacoes() {
      let clienteSelecionado = document.getElementById('cliente').value;

      let reclamacoes = clientesData
        .filter(d => d.cliente === clienteSelecionado)
        .map(d => ({ problema: d.problema, quantidade: d.quantidade }));

      let problemas = reclamacoes.map(r => r.problema);
      let quantidades = reclamacoes.map(r => r.quantidade);

      // Se já existir um gráfico, destruí-lo antes de criar um novo
      if (chart) {
        chart.destroy();
      }

      let ctx = document.getElementById('reclamacoesChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: problemas,
          datasets: [{
            data: quantidades,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(tooltipItem) {
                  return `${problemas[tooltipItem.dataIndex]}: ${quantidades[tooltipItem.dataIndex]}`;
                }
              }
            }
          }
        }
      });
    }
  </script>
</body>
</html>
