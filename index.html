<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reclamações por Cliente e Setor</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.17.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .chart-container {
      width: 50%;
      margin: 20px 0;
    }
    .chart-container canvas.loaded {
      display: block;
    }
    select {
      margin: 10px 0;
      padding: 5px;
    }
    .scrollable-content {
      max-height: 90vh;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="scrollable-content">
    <h2>Reclamações por Cliente</h2>
    <select id="clienteSelect">
      <option value="all">Todos os Clientes</option>
    </select>
    <div class="chart-container">
      <canvas id="clienteReclamacoesChart"></canvas>
    </div>

    <h2>Reclamações por Setor</h2>
    <select id="setorSelect">
      <option value="all">Todos os Setores</option>
    </select>
    <select id="clienteSetorSelect">
      <option value="all">Todos os Clientes</option>
    </select>
    <div class="chart-container">
      <canvas id="sectorReclamacoesChart"></canvas>
    </div>
  </div>

  <script>
    let reclamacoesData;
    let clienteChart, sectorChart;

    // Função para agrupar problemas por nome e somar as quantidades
    function agruparProblemas(reclamacoes) {
      let agrupado = {};
      reclamacoes.forEach(reclamacao => {
        let problema = reclamacao.problema;
        let quantidade = reclamacao.quantidade;
        if (agrupado[problema]) {
          agrupado[problema] += quantidade;
        } else {
          agrupado[problema] = quantidade;
        }
      });
      return agrupado;
    }

    // Função para carregar os dados do Excel e inicializar os gráficos
    function carregarDados() {
      const file = '/mnt/data/atendimento ao cliente.xlsx'; // Ajuste o caminho conforme necessário
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        reclamacoesData = XLSX.utils.sheet_to_json(sheet, { header: 1 }).slice(1).map(row => ({
          cliente: row[2],
          setor: row[3],
          problema: row[4],
          quantidade: row[6]
        }));

        preencherSelects();
        atualizarGraficoCliente('all');
        document.querySelector('canvas').classList.add('loaded');
      };
      fetch(file).then(response => response.blob()).then(blob => reader.readAsArrayBuffer(blob));
    }

    // Preencher as opções dos selects de clientes e setores
    function preencherSelects() {
      let clientes = [...new Set(reclamacoesData.map(r => r.cliente))];
      let clienteSelect = document.getElementById('clienteSelect');
      let clienteSetorSelect = document.getElementById('clienteSetorSelect');
      clientes.forEach(cliente => {
        let option = document.createElement('option');
        option.value = cliente;
        option.textContent = cliente;
        clienteSelect.appendChild(option);

        let optionSetor = document.createElement('option');
        optionSetor.value = cliente;
        optionSetor.textContent = cliente;
        clienteSetorSelect.appendChild(optionSetor);
      });

      let setores = [...new Set(reclamacoesData.map(r => r.setor))];
      let setorSelect = document.getElementById('setorSelect');
      setores.forEach(setor => {
        let option = document.createElement('option');
        option.value = setor;
        option.textContent = setor;
        setorSelect.appendChild(option);
      });
    }

    // Atualizar gráfico de reclamações por cliente
    function atualizarGraficoCliente(cliente) {
      let reclamacoes = reclamacoesData
        .filter(d => cliente === 'all' || d.cliente === cliente)
        .map(d => ({ problema: d.problema, quantidade: d.quantidade }));

      let reclamacoesAgrupadas = agruparProblemas(reclamacoes);
      let problemas = Object.keys(reclamacoesAgrupadas);
      let quantidades = Object.values(reclamacoesAgrupadas);

      if (clienteChart) {
        clienteChart.destroy();
      }

      let ctx = document.getElementById('clienteReclamacoesChart').getContext('2d');
      clienteChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: problemas.map((p, index) => `${p}: ${quantidades[index]} defeituosos`),
          datasets: [{
            data: quantidades,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(tooltipItem) {
                  return `${problemas[tooltipItem.dataIndex]}: ${quantidades[tooltipItem.dataIndex]} defeituosos`;
                }
              }
            }
          }
        }
      });
    }

    // Atualizar gráfico de reclamações por setor e cliente
    function atualizarGraficoSetor(setor, cliente) {
      let reclamacoes = reclamacoesData
        .filter(d => (setor === 'all' || d.setor === setor) && (cliente === 'all' || d.cliente === cliente))
        .map(d => ({ problema: d.problema, quantidade: d.quantidade }));

      let reclamacoesAgrupadas = agruparProblemas(reclamacoes);
      let problemas = Object.keys(reclamacoesAgrupadas);
      let quantidades = Object.values(reclamacoesAgrupadas);

      if (sectorChart) {
        sectorChart.destroy();
      }

      let ctx = document.getElementById('sectorReclamacoesChart').getContext('2d');
      sectorChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: problemas.map((p, index) => `${p}: ${quantidades[index]} defeituosos`),
          datasets: [{
            data: quantidades,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'top',
            },
            tooltip: {
              callbacks: {
                label: function(tooltipItem) {
                  return `${problemas[tooltipItem.dataIndex]}: ${quantidades[tooltipItem.dataIndex]} defeituosos`;
                }
              }
            }
          }
        }
      });
    }

    // Eventos para os selects
    document.getElementById('clienteSelect').addEventListener('change', function () {
      atualizarGraficoCliente(this.value);
    });

    document.getElementById('setorSelect').addEventListener('change', function () {
      atualizarGraficoSetor(this.value, document.getElementById('clienteSetorSelect').value);
    });

    document.getElementById('clienteSetorSelect').addEventListener('change', function () {
      atualizarGraficoSetor(document.getElementById('setorSelect').value, this.value);
    });

    // Carregar dados ao abrir a página
    window.onload = carregarDados;
  </script>

</body>
</html>
